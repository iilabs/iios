# iios Squid configuration tuned for large offline caches
# Based on sameersbn/squid 3.5 image defaults

http_port 0.0.0.0:3128 ssl-bump cert=/etc/squid/certs/squid-ca.pem key=/etc/squid/certs/squid-ca.key generate-host-certificates=on dynamic_cert_mem_cache_size=16MB

# Access control lists
acl iios_ssl_ports port 443
acl iios_safe_ports port 80 443 1025-65535
acl iios_connect method CONNECT
acl iios_localhost src 127.0.0.1/32
acl iios_localhost6 src ::1/128
acl iios_localnet src 10.0.0.0/8 172.16.0.0/12 192.168.0.0/16 fc00::/7 fe80::/10
acl iios_any src all
acl iios_step1 at_step SslBump1
acl iios_step2 at_step SslBump2
acl iios_step3 at_step SslBump3
acl iios_bump_all ssl::server_name_regex -i .+

http_access deny !iios_safe_ports
http_access deny iios_connect !iios_ssl_ports
http_access allow iios_localhost
http_access allow iios_localhost6
http_access allow iios_localnet
http_access allow iios_any
http_access deny all

# Cache tuning for large artifacts
cache_mem 256 MB
maximum_object_size 2048 MB
maximum_object_size_in_memory 1 MB
cache_replacement_policy heap LFUDA
memory_replacement_policy heap GDSF
collapsed_forwarding on
store_dir_select_algorithm least-load

# Disk cache layout (adjust size as needed)
cache_dir aufs /var/spool/squid 40960 16 256

# Refresh patterns for package/container registries
refresh_pattern -i \.rpm$ 1440 20% 4320
refresh_pattern -i \.deb$ 1440 20% 4320
refresh_pattern -i \.flatpakref$ 1440 20% 4320
refresh_pattern -i (registry|docker|ghcr)\.io/.* 1440 20% 4320
refresh_pattern . 0 20% 4320

# Logging
cache_log /var/log/squid/cache.log
access_log stdio:/var/log/squid/access.log
cache_store_log stdio:/var/log/squid/store.log

pid_filename /var/run/squid.pid
coredump_dir /var/spool/squid

ssl_bump peek iios_step1
ssl_bump bump iios_bump_all
ssl_bump splice all

sslcrtd_program /usr/lib64/squid/security_file_certgen -s /var/spool/squid/ssl_db -M 64MB
sslcrtd_children 5 startup=1 idle=1
tls_outgoing_options cafile=/etc/pki/tls/certs/ca-bundle.crt
sslproxy_cert_error allow all

# Placeholder TLS options (additional tuning may be required for ssl-bump)
